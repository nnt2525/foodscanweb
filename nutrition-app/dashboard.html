<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NutriTrack</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="page-wrapper">
        <main class="main-content">
            <div class="container fade-in">
                <!-- Greeting -->
                <div class="mb-6">
                    <h1 class="text-3xl font-bold" id="greeting">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ!</h1>
                    <p class="text-gray">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-4 grid-responsive mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                            <span class="stat-card-icon">üî•</span>
                        </div>
                        <p class="stat-card-value" id="todayCalories">1,850</p>
                        <p class="stat-card-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 2,000 kcal</p>
                        <div class="progress-bar mt-3">
                            <div class="progress-bar-fill" id="caloriesProgress" style="width: 92.5%"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray">‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô</span>
                            <span class="stat-card-icon">üí™</span>
                        </div>
                        <p class="stat-card-value" style="color: #3b82f6;">45g</p>
                        <p class="stat-card-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 50g</p>
                        <div class="progress-bar mt-3">
                            <div class="progress-bar-fill blue" style="width: 90%"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray">‡∏Ñ‡∏≤‡∏£‡πå‡πÇ‡∏ö‡πÑ‡∏Æ‡πÄ‡∏î‡∏£‡∏ï</span>
                            <span class="stat-card-icon">üçö</span>
                        </div>
                        <p class="stat-card-value" style="color: #f59e0b;">250g</p>
                        <p class="stat-card-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 300g</p>
                        <div class="progress-bar mt-3">
                            <div class="progress-bar-fill orange" style="width: 83%"></div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô</span>
                            <span class="stat-card-icon">ü•ë</span>
                        </div>
                        <p class="stat-card-value" style="color: #8b5cf6;">55g</p>
                        <p class="stat-card-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: 70g</p>
                        <div class="progress-bar mt-3">
                            <div class="progress-bar-fill"
                                style="width: 78%; background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                        </div>
                    </div>
                </div>

                <!-- Chart & Quick Actions -->
                <div class="grid grid-cols-3 grid-responsive mb-8">
                    <div class="card" style="grid-column: span 2;">
                        <h2 class="text-xl font-bold mb-4">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</h2>
                        <div style="height: 250px;">
                            <canvas id="caloriesChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                        <div style="height: 250px; position: relative;">
                            <canvas id="dailyChart"></canvas>
                            <!-- Center Text -->
                            <div
                                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div class="text-sm text-gray">‡∏£‡∏ß‡∏°</div>
                                <div class="text-xl font-bold">1,850</div>
                                <div class="text-xs text-gray">kcal</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Foods & Quick Actions -->
                <div class="grid grid-cols-3 grid-responsive mb-8">
                    <!-- Recent Foods -->
                    <div class="card" style="grid-column: span 2;">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                            <a href="planner.html" class="text-primary">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
                        </div>
                        <div class="grid grid-cols-2 grid-responsive" id="recentFoods"></div>
                    </div>

                    <!-- Quick Menu (Moved here) -->
                    <div class="card">
                        <h2 class="text-xl font-bold mb-4">‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô</h2>
                        <div class="flex flex-col gap-4">
                            <a href="search.html" class="btn btn-secondary btn-block">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</a>
                            <a href="scanner.html" class="btn btn-secondary btn-block">üì∏ ‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</a>
                            <a href="planner.html" class="btn btn-secondary btn-block">üìÖ ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏°‡∏∑‡πâ‡∏≠</a>
                            <a href="progress.html" class="btn btn-primary btn-block">üìä ‡∏î‡∏π‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navigation.js"></script>
    <script>
        // Check auth
        if (!requireAuth()) throw new Error('Not authorized');

        // Set greeting
        const user = getCurrentUser();
        document.getElementById('greeting').textContent = `${getGreeting()}, ${user.name}!`;

        // Get Summary Data from LocalStorage (Real Data)
        const meals = getFromLocalStorage('nutritrack_meals', { breakfast: [], lunch: [], dinner: [], snacks: [] });

        // Calculate totals
        const calories = {
            breakfast: meals.breakfast.reduce((sum, item) => sum + item.calories, 0),
            lunch: meals.lunch.reduce((sum, item) => sum + item.calories, 0),
            dinner: meals.dinner.reduce((sum, item) => sum + item.calories, 0),
            snacks: meals.snacks.reduce((sum, item) => sum + item.calories, 0)
        };
        const totalCalories = Object.values(calories).reduce((a, b) => a + b, 0);
        const goalCalories = 2000;

        // Update UI stats
        document.getElementById('todayCalories').textContent = formatNumber(totalCalories);
        document.getElementById('caloriesProgress').style.width = Math.min((totalCalories / goalCalories) * 100, 100) + '%';

        // Update Chart Center Text (if possible via simple DOM, otherwise it's just visual in canvas)
        // Since we drew it manually in canvas before? No, it was HTML over canvas.
        const centerTextContainer = document.querySelector('#dailyChart').nextElementSibling;
        if (centerTextContainer) {
            centerTextContainer.querySelector('.text-xl').textContent = formatNumber(totalCalories);
        }

        // Render recent foods
        const recentFoodsEl = document.getElementById('recentFoods');
        // Combine all meals and sort by "recent" (assuming order in array is chronological)
        // Actually we don't store timestamp, so just take latest added (end of arrays)
        const allMeals = [
            ...meals.breakfast,
            ...meals.lunch,
            ...meals.dinner,
            ...meals.snacks
        ].reverse().slice(0, 4); // Take last 4 added

        if (allMeals.length === 0) {
            recentFoodsEl.innerHTML = '<div class="text-gray col-span-2 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';
        } else {
            recentFoodsEl.innerHTML = ''; // Clear
            allMeals.forEach(food => {
                // Determine image based on food name or use generic hash-based image to be consistent if no image saved
                // Since our simple planner only saves name and calories (from planner.html logic), we might miss image/category.
                // Let's assume we saved full object or fallback.
                // Looking at planner.html... saveToLocalStorage seems to save what we put in specific functions?
                // Wait, planner.html currently only displays items. How do we ADD?
                // Ah, planner.html has "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°" which goes to search.html. 
                // We need to check if search.html adds to 'nutritrack_meals'.

                // FALLBACK for now: If image/category missing, use placeholders.
                const image = food.image || 'assets/images/placeholder-food.png';
                const category = food.category || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';

                recentFoodsEl.innerHTML += `
                    <div class="food-card">
                        <div class="food-card-content p-3">
                            <h3 class="food-card-title text-base">${food.name}</h3>
                            <p class="food-card-category text-xs">${category}</p>
                            <span class="food-card-calories text-sm">${food.calories} kcal</span>
                        </div>
                    </div>
                `;
            });
        }

        // Chart (Weekly - Keep Mock for now as we don't have history storage yet)
        const ctx = document.getElementById('caloriesChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: mockProgressData.labels,
                datasets: [{
                    label: '‡πÅ‡∏Ñ‡∏•‡∏≠‡∏£‡∏µ‡πà',
                    data: mockProgressData.calories,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: false, min: 1500, max: 2500 }
                }
            }
        });

        // Daily Chart (Real Data)
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'doughnut',
            data: {
                labels: ['‡πÄ‡∏ä‡πâ‡∏≤', '‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô', '‡πÄ‡∏¢‡πá‡∏ô', '‡∏Ç‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á'],
                datasets: [{
                    data: [calories.breakfast, calories.lunch, calories.dinner, calories.snacks],
                    backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    }
                }
            }
        });
    </script>
</body>

</html>