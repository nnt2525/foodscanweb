<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô - NutriTrack</title>
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/utilities.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="../css/auth.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="auth-page">
    <div class="auth-container fade-in">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" class="auth-logo">
                    <span class="logo-icon">ü•ó</span>
                    <span class="logo-text">NutriTrack</span>
                </a>
                <h2 class="auth-title">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
                <p class="auth-subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</p>
            </div>

            <!-- Request Reset Form -->
            <form id="forgotPasswordForm" class="auth-form" style="display: block;">
                <div class="form-group">
                    <label for="email" class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
                </div>

                <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
                    <span id="btnText">‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</span>
                    <span id="btnLoader" class="loader" style="display: none;"></span>
                </button>

                <div id="message" class="alert" style="display: none; margin-top: 1rem;"></div>
            </form>

            <!-- Reset Password Form (shown after clicking email link) -->
            <form id="resetPasswordForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="newPassword" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"
                        required minlength="6">
                </div>

                <div class="form-group">
                    <label for="confirmPassword" class="form-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
                        required>
                </div>

                <button type="submit" class="btn btn-primary btn-block" id="resetBtn">
                    <span id="resetBtnText">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
                    <span id="resetBtnLoader" class="loader" style="display: none;"></span>
                </button>

                <div id="resetMessage" class="alert" style="display: none; margin-top: 1rem;"></div>
            </form>

            <div class="auth-footer">
                <p>
                    <a href="login.html" class="link">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                </p>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // Check for reset token in URL
        const urlParams = new URLSearchParams(window.location.search);
        const resetToken = urlParams.get('token');

        if (resetToken) {
            // Show reset password form
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('resetPasswordForm').style.display = 'block';
            document.querySelector('.auth-title').textContent = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
            document.querySelector('.auth-subtitle').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
        }

        // Forgot Password Form
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            const message = document.getElementById('message');

            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            message.style.display = 'none';

            try {
                const response = await api.post('/auth/forgot-password', { email });

                message.className = 'alert alert-success';
                message.textContent = response.message || '‡∏´‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ ‡∏ó‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
                message.style.display = 'block';

                // Show token for development testing
                if (response.resetToken) {
                    const devInfo = document.createElement('p');
                    devInfo.className = 'text-sm text-gray mt-2';
                    devInfo.innerHTML = `<strong>[DEV]</strong> <a href="forgot-password.html?token=${response.resetToken}">Click to reset</a>`;
                    message.appendChild(devInfo);
                }

                document.getElementById('email').value = '';
            } catch (error) {
                message.className = 'alert alert-danger';
                message.textContent = error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
                message.style.display = 'block';
            } finally {
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        });

        // Reset Password Form
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const btnText = document.getElementById('resetBtnText');
            const btnLoader = document.getElementById('resetBtnLoader');
            const message = document.getElementById('resetMessage');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                message.className = 'alert alert-danger';
                message.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô';
                message.style.display = 'block';
                return;
            }

            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            message.style.display = 'none';

            try {
                const response = await api.post('/auth/reset-password', {
                    token: resetToken,
                    newPassword
                });

                message.className = 'alert alert-success';
                message.textContent = '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
                message.style.display = 'block';

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } catch (error) {
                message.className = 'alert alert-danger';
                message.textContent = error.message || '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
                message.style.display = 'block';
            } finally {
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        });
    </script>
</body>

</html>