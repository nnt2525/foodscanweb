-- ========================================
-- NutriTrack Complete Database
-- Generated by NutriTrack Builder
-- ========================================
DROP DATABASE IF EXISTS nutritrack;
CREATE DATABASE nutritrack CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE nutritrack;

CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role ENUM('admin', 'user') DEFAULT 'user',
    avatar VARCHAR(255),
    weight DECIMAL(5,2),
    height DECIMAL(5,2),
    age INT,
    gender ENUM('male', 'female'),
    activity_level VARCHAR(50),
    goal VARCHAR(50),
    daily_calories INT DEFAULT 2000,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE categories (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    icon VARCHAR(10),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE nutrients (
    id INT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(50) UNIQUE NOT NULL,
    name_th VARCHAR(100),
    name_en VARCHAR(100),
    unit VARCHAR(20),
    daily_value DECIMAL(10,2),
    category ENUM('macro', 'vitamin', 'mineral', 'other') DEFAULT 'other'
);

CREATE TABLE foods (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    name_en VARCHAR(255),
    brand VARCHAR(100),         
    barcode VARCHAR(50),        
    calories INT NOT NULL DEFAULT 0,
    protein DECIMAL(6,2) DEFAULT 0,
    carbs DECIMAL(6,2) DEFAULT 0,
    fat DECIMAL(6,2) DEFAULT 0,
    fiber DECIMAL(6,2) DEFAULT 0,
    serving_size VARCHAR(100),
    image_url VARCHAR(500),
    category_id INT,
    source VARCHAR(50) DEFAULT 'system',
    external_id VARCHAR(100),   
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'approved',
    created_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE TABLE food_nutrients (
    id INT PRIMARY KEY AUTO_INCREMENT,
    food_id INT NOT NULL,
    nutrient_id INT NOT NULL,
    amount DECIMAL(10,4) NOT NULL,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE CASCADE,
    FOREIGN KEY (nutrient_id) REFERENCES nutrients(id) ON DELETE CASCADE
);

CREATE TABLE portion_sizes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    food_id INT NOT NULL,
    name VARCHAR(100) NOT NULL,
    grams DECIMAL(8,2) NOT NULL,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE CASCADE
);

CREATE TABLE meal_plans (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    date DATE NOT NULL,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_date (user_id, date)
);

CREATE TABLE meal_items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    meal_plan_id INT NOT NULL,
    food_id INT NOT NULL,
    meal_type ENUM('breakfast', 'lunch', 'dinner', 'snacks') NOT NULL,
    quantity DECIMAL(5,2) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (meal_plan_id) REFERENCES meal_plans(id) ON DELETE CASCADE,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE CASCADE
);

CREATE TABLE food_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    food_id INT NOT NULL,
    meal_type ENUM('breakfast', 'lunch', 'dinner', 'snacks') NOT NULL,
    quantity DECIMAL(5,2) DEFAULT 1,
    logged_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (food_id) REFERENCES foods(id) ON DELETE CASCADE
);

CREATE TABLE posts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    image_url VARCHAR(255),
    likes INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE comments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    post_id INT NOT NULL,
    user_id INT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE achievements (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    badge_type VARCHAR(50) NOT NULL,
    earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_badge (user_id, badge_type)
);

-- Seed Data
INSERT IGNORE INTO users (id, email, password, name, role, daily_calories) VALUES (1, 'admin@nutritrack.com', '$2a$10$8K1p/a0dL1LXMIgoEDFrwOfMQHLVLmXRbJZz6LrVQDxGIFqJ6Iyje', 'Admin NutriTrack', 'admin', 2000);
INSERT IGNORE INTO users (id, email, password, name, role, daily_calories) VALUES (2, 'user@nutritrack.com', '$2a$10$8K1p/a0dL1LXMIgoEDFrwOfMQHLVLmXRbJZz6LrVQDxGIFqJ6Iyje', 'User NutriTrack', 'user', 2000);

INSERT IGNORE INTO categories (id, name, icon) VALUES 
(1, 'อาหารจานเดียว/เนื้อสัตว์', 'mw'), (2, 'ข้าว/เส้น/แป้ง', 'cw'), (3, 'แกง/ต้ม', 'sw'), (4, 'ผัด/ทอด/ไขมัน', 'fw'),
(5, 'ผัก/สลัด', 'vw'), (6, 'ผลไม้/ของว่าง', 'fr'), (7, 'ขนมหวาน', 'dw'), (8, 'เครื่องดื่ม', 'bw');

INSERT IGNORE INTO nutrients (code, name_th, name_en, unit, daily_value, category) VALUES
('ENERGY', 'พลังงาน', 'Energy', 'kcal', 2000, 'macro'),
('PROTEIN', 'โปรตีน', 'Protein', 'g', 50, 'macro'),
('FAT', 'ไขมัน', 'Total Fat', 'g', 78, 'macro'),
('CARBS', 'คาร์โบไฮเดรต', 'Carbohydrates', 'g', 275, 'macro'),
('FIBER', 'ใยอาหาร', 'Fiber', 'g', 28, 'macro'),
('SUGAR', 'น้ำตาล', 'Sugars', 'g', 50, 'macro'),
('SODIUM', 'โซเดียม', 'Sodium', 'mg', 2300, 'mineral'),
('CALCIUM', 'แคลเซียม', 'Calcium', 'mg', 1000, 'mineral'),
('IRON', 'ธาตุเหล็ก', 'Iron', 'mg', 18, 'mineral'),
('VITC', 'วิตามินซี', 'Vitamin C', 'mg', 90, 'vitamin'),
('VITA', 'วิตามินเอ', 'Vitamin A', 'mcg', 900, 'vitamin'),
('VITD', 'วิตามินดี', 'Vitamin D', 'mcg', 20, 'vitamin');

-- Thai Foods
INSERT INTO foods (name, name_en, calories, protein, carbs, fat, fiber, serving_size, category_id, source, status) VALUES 
('ข้าวมันไก่', 'Hainanese Chicken Rice', 600, 30, 65, 22, 1, '1 จาน', 1, 'THAI', 'approved'),
('ข้าวผัดกะเพราหมูสับ', 'Basil Pork with Rice', 520, 22, 58, 20, 2, '1 จาน', 1, 'THAI', 'approved'),
('ต้มยำกุ้ง', 'Tom Yum Kung', 180, 22, 8, 6, 2, '1 ถ้วย', 3, 'THAI', 'approved'),
('ส้มตำไทย', 'Papaya Salad', 120, 4, 18, 4, 4, '1 จาน', 5, 'THAI', 'approved'),
('แกงเขียวหวานไก่', 'Green Curry Chicken', 380, 22, 12, 28, 3, '1 ถ้วย', 3, 'THAI', 'approved'),
('ไข่ต้ม', 'Boiled Egg', 78, 6, 0.5, 5, 0, '1 ฟอง', 1, 'THAI', 'approved'),
('กล้วยหอม', 'Banana', 105, 1.3, 27, 0.4, 3, '1 ลูก', 6, 'THAI', 'approved');

-- USDA Foods (Sample subset for brevity, user provided many more)
INSERT INTO foods (name, name_en, brand, barcode, calories, protein, carbs, fat, fiber, serving_size, category_id, source, external_id, status, created_by) VALUES ('Rice, Brown, Long Grain, Parboiled (Chefway)', 'Rice, Brown, Long Grain, Parboiled (Chefway)', 'Chefway', '10035200265673', 150, 3.0, 32.0, 1.0, 1.0, '44 GRM', 2, 'USDA', '100500', 'approved', 1);
INSERT INTO food_nutrients (food_id, nutrient_id, amount) SELECT id, (SELECT id FROM nutrients WHERE code='IRON'), 0.5 FROM foods WHERE source='USDA' AND external_id='100500';
INSERT INTO foods (name, name_en, brand, barcode, calories, protein, carbs, fat, fiber, serving_size, category_id, source, external_id, status, created_by) VALUES ('Rice, Brown, Long Grain, Parboiled (Chefway)', 'Rice, Brown, Long Grain, Parboiled (Chefway)', 'Chefway', '35200265683', 150, 3.0, 32.0, 1.0, 1.0, '44 GRM', 2, 'USDA', '101031', 'approved', 1);
INSERT INTO food_nutrients (food_id, nutrient_id, amount) SELECT id, (SELECT id FROM nutrients WHERE code='IRON'), 0.5 FROM foods WHERE source='USDA' AND external_id='101031';
INSERT INTO foods (name, name_en, brand, barcode, calories, protein, carbs, fat, fiber, serving_size, category_id, source, external_id, status, created_by) VALUES ('Spinach, Chopped, No Salt Added, Frozen (IQF) (Margaret Holmes)', 'Spinach, Chopped, No Salt Added, Frozen (IQF) (Margaret Holmes)', 'Margaret Holmes', '10041443140028', 31, 4.0, 4.0, 1.0, 3.0, '113 GRM', 5, 'USDA', '110425', 'approved', 1);
INSERT INTO food_nutrients (food_id, nutrient_id, amount) SELECT id, (SELECT id FROM nutrients WHERE code='CALCIUM'), 136.0 FROM foods WHERE source='USDA' AND external_id='110425';
INSERT INTO food_nutrients (food_id, nutrient_id, amount) SELECT id, (SELECT id FROM nutrients WHERE code='IRON'), 4.0 FROM foods WHERE source='USDA' AND external_id='110425';